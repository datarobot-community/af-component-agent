---
# https://taskfile.dev
version: '3'
env :
  RENDER_DIR: .rendered
tasks:
  default:
    desc: "Show all available tasks"
    cmds:
      - task --list
    silent: true
  render-template:
    desc: "Render template"
    cmds:
      - echo "Rendering template {{.AGENT}}"
      - uvx copier copy . ./$RENDER_DIR/agent_{{.AGENT}} --defaults --data agent_template_framework={{.AGENT}} --vcs-ref=HEAD
      - cp ./fixtures/Taskfile.yml ./$RENDER_DIR/agent_{{.AGENT}}/Taskfile.yml
      - cp ./fixtures/infra/pyproject.toml ./$RENDER_DIR/agent_{{.AGENT}}/infra/pyproject.toml
      - cp ./fixtures/infra/__init__.py ./$RENDER_DIR/agent_{{.AGENT}}/infra/infra/__init__.py
  install-dev:
    desc: "Install dev"
    cmds:
      - echo "Installing dev for {{.AGENT}}"
      - task: render-template
        vars:
          AGENT: "{{.AGENT}}"
      - task agent_test:agent:install --dir $RENDER_DIR/agent_{{.AGENT}}
  test-agent:
    desc: "Run tests"
    cmds:
      - task: install-dev
        vars:
          AGENT: "{{.AGENT}}"
      - echo "Running tests for {{.AGENT}}"
      - task agent:lint-check --dir $RENDER_DIR/agent_{{.AGENT}}
      - task agent:test-coverage --dir $RENDER_DIR/agent_{{.AGENT}}
  test-base:
    desc: "Run tests for base agent"
    cmds:
      - task: test-agent
        vars:
          AGENT: base
  test-nat:
    desc: "Run tests for base agent"
    cmds:
      - task: test-agent
        vars:
          AGENT: nat
  test-crewai:
    desc: "Run tests for crewai agent"
    cmds:
      - task: test-agent
        vars:
          AGENT: crewai
  test-langgraph:
    desc: "Run tests for langgraph agent"
    cmds:
      - task: test-agent
        vars:
          AGENT: langgraph
  test-llamaindex:
    desc: "Run tests for llamaindex agent"
    cmds:
      - task: test-agent
        vars:
          AGENT: llamaindex
  test:
    desc: "Run tests for all agents"
    cmds:
      - task: test-base
      - task: test-crewai
      - task: test-langgraph
      - task: test-llamaindex
  run-cli:
    desc: "Run CLI"
    cmds:
      - task: install-dev
        vars:
          AGENT: "base"
      - echo "Running tests for {{.AGENT}}"
      - task agent_test:agent:cli --dir $RENDER_DIR/agent_base -- execute --user_prompt "Artificial Intelligence" > $RENDER_DIR/agent_base/agent/output.log 2>&1
  test-cli:
    desc: "Test CLI"
    cmds:
      - task: run-cli
      - task: check-output
  check-output:
      - if [ $(wc -l < $RENDER_DIR/agent_base/agent/output.log) -lt 13 ]; then exit 1; fi
      - if ! cat $RENDER_DIR/agent_base/agent/output.log | grep -q "Running CLI execute"; then exit 1; fi
      - if ! cat $RENDER_DIR/agent_base/agent/output.log | grep -q "INFO - Parsing args"; then exit 1; fi
      - if ! cat $RENDER_DIR/agent_base/agent/output.log | grep -q "INFO - Starting DRUM runner"; then exit 1; fi
      - if ! cat $RENDER_DIR/agent_base/agent/output.log | grep -q "Running agent with inputs"; then exit 1; fi
      - 'if ! cat $RENDER_DIR/agent_base/agent/output.log | grep -q "\"content\": \"success\""; then exit 1; fi'
  run-cli-json:
    desc: "Run CLI with JSON"
    cmds:
      - task: install-dev
        vars:
          AGENT: "base"
      - echo "Running tests for {{.AGENT}}"
      - task agent:cli --dir $RENDER_DIR/agent_base -- execute --completion_json example-completion.json > $RENDER_DIR/agent_base/agent/output.log 2>&1
  test-cli-json:
    desc: "Test CLI with JSON"
    cmds:
      - task: run-cli-json
      - task: check-output
  build-docker:
    desc: "Build docker image"
    cmds:
      - task: install-dev
        vars:
          AGENT: "{{.AGENT}}"
      - echo "Building docker image for {{.AGENT}}"
      - task agent_test:agent:build-docker --dir $RENDER_DIR/agent_{{.AGENT}}
  build-docker-base:
    desc: "Build docker for base agent"
    cmds:
      - task: build-docker
        vars:
          AGENT: base
  build-docker-crewai:
    desc: "Build docker for crewai agent"
    cmds:
      - task: build-docker
        vars:
          AGENT: crewai
  build-docker-langgraph:
    desc: "Build docker for langgraph agent"
    cmds:
      - task: build-docker
        vars:
          AGENT: langgraph
  build-docker-llamaindex:
    desc: "Build docker for llamaindex agent"
    cmds:
      - task: build-docker
        vars:
          AGENT: llamaindex
