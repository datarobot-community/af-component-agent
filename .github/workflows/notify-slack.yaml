name: Notify GenAI team on "Ready for review" PRs

on:
  pull_request:
    types: [labeled]
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Send notification to Slack
        if: github.event_name != 'schedule'
        run: |
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          PR_NR="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_ADDITIONS="${{ github.event.pull_request.additions }}"
          PR_DELETIONS="${{ github.event.pull_request.deletions }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          # Escape special characters for JSON
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | sed 's/\\/\\\\/g; s/"/\\"/g')
          PR_AUTHOR_ESCAPED=$(echo "$PR_AUTHOR" | sed 's/\\/\\\\/g; s/"/\\"/g')
          REPO_NAME_ESCAPED=$(echo "$REPO_NAME" | sed 's/\\/\\\\/g; s/"/\\"/g')

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*Pull Request Ready for Review!*\", 
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"@buzok-team: :rocket: PR by ${PR_AUTHOR_ESCAPED} needs a review: \`+${PR_ADDITIONS} -${PR_DELETIONS}\` <${PR_URL}|${REPO_NAME_ESCAPED}#${PR_NR}: ${PR_TITLE_ESCAPED}>\"
                }
              }
            ]
          }" \
          "${SLACK_WEBHOOK_URL}"
      - name: Send summary notification to Slack
        if: github.event_name == 'schedule'
        run: |
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          REPO_NAME="${{ github.repository }}"
          
          # Get PRs with "Ready for Review" label
          PRS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${REPO_NAME}/pulls?state=open&per_page=100")
          
          # Filter PRs with "Ready for Review" label and format them
          PR_LIST=""
          echo "$PRS_JSON" | jq -r '.[] | select(.labels[]?.name == "Ready for review") | 
            "â€¢ " + .title + " by " + .user.login + " needs a review: `+" + (.additions|tostring) + " -" + (.deletions|tostring) + "` <" + .html_url + "|#" + (.number|tostring) + ">"' | \
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              # Escape special characters for JSON
              ESCAPED_LINE=$(echo "$line" | sed 's/\\/\\\\/g; s/"/\\"/g')
              if [ -z "$PR_LIST" ]; then
                PR_LIST="$ESCAPED_LINE"
              else
                PR_LIST="$PR_LIST\\n$ESCAPED_LINE"
              fi
            fi
          done
          
          # Only send notification if there are PRs ready for review
          if [ -n "$PR_LIST" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"*Pull Requests Ready for Review Summary*\", 
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"@buzok-team: :clipboard: Here are the open PRs ready for review:\\n$PR_LIST\"
                  }
                }
              ]
            }" \
            "${SLACK_WEBHOOK_URL}"
          fi
