name: Notify GenAI team on "Ready for review" PRs

on:
  pull_request:
    types: [labeled]
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Send notification to Slack
        if: github.event_name == 'pull_request' && contains(toLower(github.event.label.name), 'ready for review')
        run: |
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          PR_NR="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_ADDITIONS="${{ github.event.pull_request.additions }}"
          PR_DELETIONS="${{ github.event.pull_request.deletions }}"
          REPO_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"

          # Get changed files (first 3)
          FILES_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$OWNER/$REPO_NAME/pulls/$PR_NR/files?per_page=3")
          FILE_LINES=""
          COUNT=0
          echo "$FILES_JSON" | jq -c '.[]' | while read -r file; do
            COUNT=$((COUNT+1))
            FILENAME=$(echo "$file" | jq -r '.filename')
            ADD=$(echo "$file" | jq -r '.additions')
            DEL=$(echo "$file" | jq -r '.deletions')
            FILE_LINES="$FILE_LINES\nâ€¢ $FILENAME +$ADD -$DEL"
            if [ $COUNT -ge 3 ]; then break; fi
          done

          # Escape special characters for JSON
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | sed 's/\\/\\\\/g; s/"/\\"/g')
          PR_AUTHOR_ESCAPED=$(echo "$PR_AUTHOR" | sed 's/\\/\\\\/g; s/"/\\"/g')
          REPO_NAME_ESCAPED=$(echo "$REPO_NAME" | sed 's/\\/\\\\/g; s/"/\\"/g')
          FILE_LINES_ESCAPED=$(echo -e "$FILE_LINES" | sed 's/\\/\\\\/g; s/"/\\"/g')

          # Compose message
          MSG="@buzok-team: :rocket: PR by $PR_AUTHOR_ESCAPED needs a review::green_with_check: +$PR_ADDITIONS -$PR_DELETIONS $REPO_NAME_ESCAPED#$PR_NR: $PR_TITLE_ESCAPED based on the following changes:$FILE_LINES_ESCAPED\n<${PR_URL}|View PR>"

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$MSG\"}" \
            "${SLACK_WEBHOOK_URL}"
      - name: Send summary notification to Slack
        if: github.event_name == 'schedule'
        run: |
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          ORG="datarobot-community"
          # Get all open PRs for all repos in the org (first 100 repos)
          REPOS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/orgs/$ORG/repos?per_page=100" | jq -r '.[].name')
          NOW=$(date -u +%s)
          PR_LIST=""
          for REPO in $REPOS; do
            PRS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/$ORG/$REPO/pulls?state=open&per_page=100")
            echo "$PRS" | jq -c '.[] | select([.labels[].name | ascii_downcase] | map(contains("ready for review")) | any)' | while read -r pr; do
              NUMBER=$(echo "$pr" | jq -r '.number')
              TITLE=$(echo "$pr" | jq -r '.title')
              AUTHOR=$(echo "$pr" | jq -r '.user.login')
              URL=$(echo "$pr" | jq -r '.html_url')
              ADDITIONS=$(echo "$pr" | jq -r '.additions')
              DELETIONS=$(echo "$pr" | jq -r '.deletions')
              CREATED_AT=$(echo "$pr" | jq -r '.created_at')
              # Calculate time ago
              CREATED_AT_EPOCH=$(date -d "$CREATED_AT" +%s)
              MINUTES_AGO=$(( (NOW - CREATED_AT_EPOCH) / 60 ))
              if [ "$MINUTES_AGO" -lt 60 ]; then
                TIME_AGO="$MINUTES_AGO minutes ago"
              else
                HOURS=$((MINUTES_AGO / 60))
                MINUTES=$((MINUTES_AGO % 60))
                TIME_AGO="$HOURS hours $MINUTES minutes ago"
              fi
              # Escape for JSON
              TITLE_ESCAPED=$(echo "$TITLE" | sed 's/\\/\\\\/g; s/"/\\"/g')
              AUTHOR_ESCAPED=$(echo "$AUTHOR" | sed 's/\\/\\\\/g; s/"/\\"/g')
              # Format: - <link|repo#pr: [title] by author (time ago) +adds -dels>
              SLACK_LINE_TEXT="$REPO#$NUMBER: [$TITLE_ESCAPED] by $AUTHOR_ESCAPED ($TIME_AGO) +$ADDITIONS -$DELETIONS (Review on behalf of GenAI Tooling (Buzok))"
              LINE="- <$URL|$SLACK_LINE_TEXT>"
              if [ -z "$PR_LIST" ]; then
                PR_LIST="$LINE"
              else
                PR_LIST="$PR_LIST\\n$LINE"
              fi
            done
          done
          # Only send notification if there are PRs ready for review
          if [ -n "$PR_LIST" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$PR_LIST\"}" \
            "${SLACK_WEBHOOK_URL}"
          fi
