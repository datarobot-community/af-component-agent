# Copyright 2025 DataRobot, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import asyncio
import os
from concurrent.futures import ThreadPoolExecutor
from typing import Any, Iterator, Union

from agent import MyAgent
from datarobot_genai.core.chat import (
    CustomModelChatResponse,
    CustomModelStreamingResponse,
)
from datarobot_genai.core.custom_model import chat_entrypoint
from datarobot_genai.core.custom_model import load_model as _load_model
from openai.types.chat import CompletionCreateParams
from openai.types.chat.completion_create_params import (
    CompletionCreateParamsNonStreaming,
    CompletionCreateParamsStreaming,
)


def load_model(code_dir: str) -> tuple[ThreadPoolExecutor, asyncio.AbstractEventLoop]:
    # The code_dir argument is part of the DRUM interface; we don't need it here.
    return _load_model()


def chat(
    completion_create_params: CompletionCreateParams
    | CompletionCreateParamsNonStreaming
    | CompletionCreateParamsStreaming,
    load_model_result: tuple[ThreadPoolExecutor, asyncio.AbstractEventLoop],
    **kwargs: Any,
) -> Union[CustomModelChatResponse, Iterator[CustomModelStreamingResponse]]:
    return chat_entrypoint(
        MyAgent,
        completion_create_params,
        load_model_result,
        work_dir=os.path.dirname(os.path.abspath(__file__)),
        {% if agent_template_framework == "crewai" -%}
        framework="crewai",
        {%- elif agent_template_framework == "langgraph" -%}
        framework="langgraph",
        {%- elif agent_template_framework == "llamaindex" -%}
        framework="llamaindex",
        {% endif %}
        **kwargs,
    )
