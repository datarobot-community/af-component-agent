---
# https://taskfile.dev
# THIS FILE MUST BE SOURCED FROM ANOTHER TASKFILE IN THE ROOT DIRECTORY
version: '3'
vars:
  UV_CMD:
    sh: |
      # This command ensures compatibility with codespaces environments
      # Cross-platform environment cleaning - uses 'env -u' on Unix systems,
      # falls back to empty string on Windows
      if command -v env >/dev/null 2>&1; then
        echo "env -u PYTHONPATH -u VIRTUAL_ENV uv"
      else
        echo "uv"
      fi
  PULUMI_STACK_COMMAND:
    sh: |
      if [ -n "${PULUMI_STACK:-}" ]; then
        echo "--stack $PULUMI_STACK"
      else
        echo ""
      fi
tasks:
  install:
    silent: true
    desc: üõ†Ô∏è [infra] Install infra uv dependencies
    cmds:
      - echo "Updating local dependencies for infra"
      - "{{.UV_CMD}} sync --extra dev --quiet"
  install-pulumi-plugin:
    silent: true
    # desc: "‚¨áÔ∏è Install DataRobot Pulumi plugins"
    cmds:
      - "{{.UV_CMD}} run pulumi plugin install resource datarobot v0.10.22 --server https://github.com/datarobot-community/pulumi-datarobot/releases/download/v0.10.22/"
  lint:
    silent: true
    # desc: "üßπ Run linters"
    cmds:
      - echo "üßπ Running linters.."
      - "{{.UV_CMD}} run ruff format ."
      - "{{.UV_CMD}} run ruff check . --fix"
      - "{{.UV_CMD}} run mypy --pretty ."
  lint-check:
    silent: true
    # desc: "üßπ Check whether the codebase is linted"
    cmds:
      - "{{.UV_CMD}} run ruff format --check --diff ."
      - "{{.UV_CMD}} run ruff check  --diff ."
      - "{{.UV_CMD}} run mypy --pretty ."
  test:
    # Hidden to avoid showing in task list, run `task --list-all` to see it
    # desc: üß™ [infra] Run tests
    cmds:
      - echo "Running pytest on tests"
      - "{{.UV_CMD}} run pytest -vv ./tests/"
    silent: true
  test-coverage:
    # Hidden to avoid showing in task list, run `task --list-all` to see it
    # desc: üß™ [infra] Run tests with coverage
    cmds:
      - echo "Running pytest on tests"
      - "{{.UV_CMD}} run pytest -vv --cov --cov-report=html --cov-report=term --cov-report xml:.coverage.xml ./tests/"
    silent: true
  init:
    silent: true
    # desc: "üÜï Initialize a new Pulumi stack"
    cmds:
      - "{{.UV_CMD}} run pulumi stack init"
  pulumi:
    silent: true
    # desc: "Generic pulumi execution command with env variables"
    cmds:
      - task: install-pulumi-plugin
      - "{{.UV_CMD}} run pulumi {{.CLI_ARGS}}"
  select:
    silent: true
    # desc: "üöÇ Select a Stack"
    cmds:
      - "{{.UV_CMD}} run pulumi stack select"
  select-env-stack:
    silent: true
    cmds:
      - |
        if [ -n "${PULUMI_STACK:-}" ]; then
          {{.UV_CMD}} run pulumi stack select -c $PULUMI_STACK
        fi
  info:
    silent: true
    # desc: "‚ÑπÔ∏è Show Pulumi stack info"
    cmds:
      - task: install-pulumi-plugin
      - task: select-env-stack
      - "{{.UV_CMD}} run pulumi stack {{.PULUMI_STACK_COMMAND}}"
  build:
    desc: "üîµ Deploy only playground testing resources with pulumi"
    env:
      AGENT_DEPLOY: 0
    cmds:
      - echo "[infra] Running pulumi up with [BUILD] mode"
      - task: install-pulumi-plugin
      - task: select-env-stack
      - "{{.UV_CMD}} run pulumi up {{.PULUMI_STACK_COMMAND}} {{.CLI_ARGS}}"
    silent: true
  deploy:
    desc: "üü¢ Deploy all resources with pulumi"
    env:
      AGENT_DEPLOY: 1
    cmds:
      - echo "Running pulumi up with [DEPLOY] mode"
      - task: install-pulumi-plugin
      - task: select-env-stack
      - "{{.UV_CMD}} run pulumi up {{.PULUMI_STACK_COMMAND}} {{.CLI_ARGS}}"
    silent: true
  refresh:
    desc: "‚ö™Ô∏è Refresh and sync local pulumi state"
    cmds:
      - echo "Running pulumi refresh"
      - task: install-pulumi-plugin
      - task: select-env-stack
      - "{{.UV_CMD}} run pulumi refresh {{.PULUMI_STACK_COMMAND}} {{.CLI_ARGS}}"
    silent: true
  destroy:
    desc: "üî¥ Teardown all deployed resources with pulumi"
    cmds:
      - echo "Running pulumi destroy"
      - task: install-pulumi-plugin
      - task: select-env-stack
      - "{{.UV_CMD}} run pulumi destroy {{.PULUMI_STACK_COMMAND}} {{.CLI_ARGS}}"
    silent: true
