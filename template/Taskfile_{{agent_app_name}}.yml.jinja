---
# https://taskfile.dev
version: '3'
vars:
  CLEAN_PYTHON_ENV: env -u PYTHONPATH -u VIRTUAL_ENV
includes:
  agent:
    taskfile: ./{{ agent_app_name }}/Taskfile.yml
    dir: ./{{ agent_app_name }}
tasks:
  default:
    desc: "🗒️ Show all available tasks"
    cmds:
      - task --list
    silent: true
  install:
    desc: "🏗️ [{{ agent_app_name }}] Install and setup the agent and infra environments"
    cmds:
      - echo "Updating agent environment"
      - task: agent:req
      - echo "Updating infra environment"
      - cd ./infra && uv sync --all-extras
    silent: true
    aliases:
      - setup
      - req
  build:
    desc: "🔵 [{{ agent_app_name }}] Run Pulumi up in [BUILD] mode"
    env:
      AGENT_DEPLOY: 0
    cmds:
      - echo "Running pulumi up with [BUILD] mode"
      - "cd ./infra && {{.CLEAN_PYTHON_ENV}} uv run pulumi up {% raw %}{{.CLI_ARGS}}{% endraw %}"
    silent: true
  deploy:
    desc: "🟢 [{{ agent_app_name }}] Run Pulumi up in [DEPLOY] mode"
    env:
      AGENT_DEPLOY: 1
    cmds:
      - echo "Running pulumi up with [DEPLOY] mode"
      - "cd ./infra && {{.CLEAN_PYTHON_ENV}} uv run pulumi up {% raw %}{{.CLI_ARGS}}{% endraw %}"
    silent: true
  refresh:
    desc: "⚪️ [{{ agent_app_name }}] Run Pulumi refresh"
    cmds:
      - echo "Running pulumi refresh"
      - "cd ./infra && {{.CLEAN_PYTHON_ENV}} uv run pulumi refresh {% raw %}{{.CLI_ARGS}}{% endraw %}"
    silent: true
  destroy:
    desc: "🔴 [{{ agent_app_name }}] Run Pulumi destroy"
    cmds:
      - echo "Running pulumi destroy"
      - "cd ./infra && {{.CLEAN_PYTHON_ENV}} uv run pulumi destroy {% raw %}{{.CLI_ARGS}}{% endraw %}"
    silent: true
